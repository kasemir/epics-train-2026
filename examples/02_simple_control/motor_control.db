
record(ao, "$(S):setpoint")
{
  field(DESC, "Desired motor speed")
  field(EGU,  "rpm")
  field(PREC, "1")
  field(DRVL, "-5000")
  field(DRVH, "5000")
  field(DOL,  "0")
  field(PINI, "YES")
}

record(calc, "$(S):error")
{
  field(DESC, "speed error")
  field(INPA, "$(S):speed")
  field(INPB, "$(S):setpoint")
  field(EGU,  "rpm")
  field(PREC, "1")
  field(SCAN, ".2 second")
  field(CALC, "B-A")
  field(FLNK, "$(S):error_sum")
}

record(ao, "$(S):error_limit")
{
  field(DESC, "Error integral limit")
  field(DOL,  "10000")
  field(PINI, "YES")
}

record(calc, "$(S):error_sum")
{
  field(DESC, "Error integral")
  field(INPA, "$(S):error_sum")
  field(INPB, "$(S):error")
  field(INPC, "$(S):error_limit")
  field(CALC, "MAX(-C, MIN(A+B, C))")
  field(FLNK, "$(S):control")
}

record(ao, "$(S):I")
{
  field(DESC, "integral gain")
  field(PREC, "4")
  field(DOL,  "0.001")
  field(PINI, "YES")
}

record(calc, "$(S):control")
{
  field(DESC, "P control")
  field(INPA, "$(S):error_sum")
  field(INPB, "$(S):I")
  field(EGU,  "V")
  field(PREC, "1")
  field(CALC, "MAX(-12,MIN(12, B*A))")
  field(FLNK, "$(S):voltage")
}

# How do we get the 'control' value into the 'voltage'?
#
# Option 1:
# Change 'control' into a 'calcout' record and add
#   field(OUT,  "$(S):voltage")
# To enable/disable, we could change the error.SCAN
#
# Option 2:
# Patch 'voltage' record to read 'control' as the desired output link,
# enable/disable via OMSL
record("*", "$(S):voltage")
{
  field(DOL,  "$(S):control")
  field(OMSL, "closed_loop")
}
